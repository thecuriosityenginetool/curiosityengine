# Sales Curiosity Engine - User Hierarchy & Privileges Walkthrough

**Date:** October 4, 2025  
**Status:** ‚úÖ Comprehensive Review Complete

---

## üìã Executive Summary

Your application has a well-designed user hierarchy system with **3 user roles**, **2 account types**, and proper Row-Level Security (RLS) policies in place. The core architecture is solid, but there are some UI/UX improvements needed to fully differentiate the experience between individual users, organizational members, and organization admins.

**User Roles:**
- `super_admin` - Reserved for future global admin (not yet implemented)
- `org_admin` - Organization administrators who can manage users and settings
- `member` - Regular users (both individual and organizational members)

**Account Types:**
- `individual` - Personal workspace (solo user)
- `organization` - Team workspace (multiple users, managed by org admin)

---

## ‚úÖ What's Working Well

### 1. Database Schema ‚≠ê
**Status:** EXCELLENT

```sql
-- Users table with role hierarchy
role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('super_admin', 'org_admin', 'member'))

-- Organizations with account types
account_type TEXT NOT NULL DEFAULT 'individual' CHECK (account_type IN ('individual', 'organization'))
```

**RLS Policies are properly configured:**
- ‚úÖ Users can view their own data
- ‚úÖ Users can view members in their organization
- ‚úÖ Org admins can manage users in their organization
- ‚úÖ Org admins can view all analyses/emails in their organization
- ‚úÖ Individual users are isolated to their own workspace

### 2. Signup & Authentication Flow ‚≠ê
**Status:** EXCELLENT

**Extension (popup.tsx):**
- ‚úÖ Shows account type selector (Individual vs Organization)
- ‚úÖ Collects organization name for organization accounts
- ‚úÖ Properly passes metadata to signup API

**Web App (signup/page.tsx):**
- ‚úÖ Beautiful UI with account type cards
- ‚úÖ Conditional organization name field
- ‚úÖ Clear visual distinction between account types

**Backend (api/auth/signup/route.ts):**
- ‚úÖ Validates organization name for org accounts
- ‚úÖ Creates user with proper metadata
- ‚úÖ Database trigger (`handle_new_user`) automatically:
  - Creates organization record
  - Assigns `org_admin` role for organization accounts
  - Assigns `member` role for individual accounts
  - Links user to organization

### 3. Login & Routing ‚≠ê
**Status:** EXCELLENT

**Login flow properly redirects based on role:**
```typescript
// login/page.tsx
if (userData.role === 'org_admin' || userData.role === 'super_admin') {
  router.push('/admin/organization');
} else {
  router.push('/'); // Home page for regular users
}
```

### 4. Organization Dashboard ‚≠ê
**Status:** EXCELLENT

**Location:** `/admin/organization/page.tsx`

**Features for Org Admins:**
- ‚úÖ View all users in organization
- ‚úÖ Invite new users (with role selection: org_admin or member)
- ‚úÖ View all analyses created by team members
- ‚úÖ View all emails generated by team members
- ‚úÖ Manage integrations (enable/disable for entire org)
- ‚úÖ View activity statistics and metrics
- ‚úÖ Role badges (ADMIN indicator)
- ‚úÖ User context viewing (aboutMe, objectives)

**Access Control:**
```typescript
// Checks if user is org_admin before showing dashboard
if (!userData || userData.role === 'member') {
  router.push('/');
  return;
}
```

### 5. Backend API Authorization ‚≠ê
**Status:** EXCELLENT

**Prospects API** (`api/prospects/route.ts`):
- ‚úÖ Saves analysis with both `user_id` and `organization_id`
- ‚úÖ Saves emails with both `user_id` and `organization_id`
- ‚úÖ RLS automatically filters data by organization

**Organization Integrations API** (`api/organization/integrations/route.ts`):
- ‚úÖ Validates auth token
- ‚úÖ Fetches user's organization and role
- ‚úÖ Returns enabled integrations for that organization

---

## ‚ö†Ô∏è Issues & Recommendations

### Issue #1: Extension Doesn't Show Organization Context
**Severity:** MEDIUM  
**Impact:** Users don't see their organization membership or role

**Current State:**
- Extension shows `user?.email` in header
- No indication if user is part of an organization
- No indication if user is an org admin
- Integrations page shows generic "Coming Soon" without checking actual org integrations

**Recommended Fix:**
```typescript
// In extension popup.tsx, add after authentication:
const [userOrg, setUserOrg] = useState<any>(null);
const [userRole, setUserRole] = useState<string>('member');

useEffect(() => {
  async function loadOrgInfo() {
    const { authToken } = await chrome.storage.local.get(['authToken']);
    const res = await chrome.runtime.sendMessage({
      type: "PING_API",
      url: `${apiBase}/api/organization/integrations`,
      method: "GET",
      authToken,
    });
    
    if (res.ok) {
      setUserOrg(res.data.organization);
      setUserRole(res.data.userRole);
      // Update integrations page to show actual enabled integrations
    }
  }
  if (isAuthenticated) loadOrgInfo();
}, [isAuthenticated]);
```

**UI Changes Needed:**
1. Show organization name in header for org users
2. Show role badge for org admins
3. Update integrations page to show actual enabled integrations
4. Add link to organization dashboard for org admins

### Issue #2: Individual vs Organizational User Experience Not Differentiated
**Severity:** LOW  
**Impact:** Individual users see the same home page as org members

**Current State:**
- Home page (`page.tsx`) is identical for all authenticated users
- No indication that individual users have a "personal workspace"
- No indication that org members are part of a team

**Recommended Enhancement:**
```typescript
// In page.tsx, add organization context
const [userData, setUserData] = useState<any>(null);

// Show different messaging based on account type
{userData?.organizations?.account_type === 'individual' ? (
  <span>Personal Workspace</span>
) : (
  <span>{userData?.organizations?.name} ‚Ä¢ {userData?.role === 'org_admin' ? 'Admin' : 'Member'}</span>
)}
```

### Issue #3: User Context Not Synced to Database
**Severity:** MEDIUM  
**Impact:** User context saved in extension is not synced to database

**Current State:**
- Extension saves `userContext` to `chrome.storage.local`
- Database has `user_context` JSONB field
- No sync between extension and database
- Org admins can't see member context in dashboard

**Recommended Fix:**
Add API endpoint to sync user context:
```typescript
// New API: /api/user/context
export async function PUT(req: NextRequest) {
  // Validate auth
  // Update users.user_context JSONB field
  // Return success
}

// In extension, save to both local storage and database:
async function saveUserContext(context: UserContext) {
  await chrome.storage.local.set({ userContext: context });
  
  const { authToken } = await chrome.storage.local.get(['authToken']);
  await chrome.runtime.sendMessage({
    type: "PING_API",
    url: `${apiBase}/api/user/context`,
    method: "PUT",
    body: { userContext: context },
    authToken,
  });
}
```

### Issue #4: Admin Page Doesn't Check Privileges
**Severity:** LOW  
**Impact:** `/admin/page.tsx` is a generic task page, doesn't verify admin role

**Current State:**
- `/admin/page.tsx` is accessible to anyone
- Shows task management UI
- Doesn't check if user is admin

**Recommended Fix:**
```typescript
// Either protect the route or redirect non-admins
useEffect(() => {
  async function checkAdmin() {
    const { data } = await supabase
      .from('users')
      .select('role')
      .eq('id', session.user.id)
      .single();
    
    if (data?.role !== 'org_admin' && data?.role !== 'super_admin') {
      router.push('/');
    }
  }
  checkAdmin();
}, []);
```

### Issue #5: No Dashboard Link for Org Admins
**Severity:** LOW  
**Impact:** Org admins don't have easy access to their dashboard from home page

**Current State:**
- Home page shows same UI for all users
- Org admins must navigate to `/admin/organization` manually
- No prominent link or button

**Recommended Fix:**
Add a navigation button for org admins:
```typescript
// In page.tsx home page
{userData?.role === 'org_admin' && (
  <Link 
    href="/admin/organization"
    className="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg"
  >
    üìä Organization Dashboard
  </Link>
)}
```

---

## üîê Security Audit

### ‚úÖ PASSED: Row-Level Security
- All tables have RLS enabled
- Policies properly restrict access by organization_id
- Org admins can only see their organization's data
- Individual users are isolated

### ‚úÖ PASSED: API Authorization
- Auth tokens validated on all protected endpoints
- User organization_id fetched from database
- Proper error handling for unauthorized access

### ‚úÖ PASSED: Data Isolation
- linkedin_analyses stored with organization_id
- email_generations stored with organization_id
- RLS automatically filters queries

### ‚úÖ PASSED: Role Hierarchy
- super_admin > org_admin > member
- Proper checks in code
- Database constraints enforced

---

## üìä User Experience Flows

### Flow 1: Individual User Signup ‚úÖ
1. User signs up choosing "Individual" account
2. Trigger creates personal organization (account_type='individual')
3. User assigned role='member'
4. User redirected to home page
5. User sees personal workspace
6. All analyses/emails saved with their organization_id
7. Only they can see their data

**Status:** Works perfectly

### Flow 2: Organization Admin Signup ‚úÖ
1. User signs up choosing "Organization" account
2. Enters organization name (e.g., "Acme Corp")
3. Trigger creates organization record (account_type='organization')
4. User assigned role='org_admin'
5. User redirected to `/admin/organization` dashboard
6. Dashboard shows empty state
7. Admin can invite team members

**Status:** Works perfectly

### Flow 3: Team Member Invitation ‚ö†Ô∏è
1. Org admin goes to organization dashboard
2. Clicks "Invite User"
3. Enters email and selects role
4. Invitation saved to user_invitations table
5. ‚ö†Ô∏è **MISSING:** No email actually sent (integration pending)
6. ‚ö†Ô∏è **MISSING:** No invitation acceptance flow
7. ‚ö†Ô∏è **MISSING:** New user can't join via invitation link

**Status:** Partially implemented - invitation stored but not sent/accepted

### Flow 4: Organization Member Using Extension ‚ö†Ô∏è
1. Member logs into extension
2. ‚ö†Ô∏è Extension doesn't show organization name
3. Member analyzes LinkedIn profile
4. Analysis saved with organization_id
5. ‚úÖ Org admin can see analysis in dashboard
6. ‚ö†Ô∏è Member doesn't know admin can see their work
7. ‚ö†Ô∏è Member can't access org dashboard to see team activity

**Status:** Works but lacks transparency

### Flow 5: Integration Management ‚úÖ
1. Org admin goes to Integrations tab
2. Enables "Salesforce" integration
3. Integration saved to organization_integrations
4. ‚ö†Ô∏è Extension doesn't check this yet
5. ‚ö†Ô∏è No actual integration functionality (coming soon)

**Status:** UI works, actual integration pending

---

## üõ†Ô∏è Priority Fixes

### üî¥ HIGH PRIORITY

1. **Implement User Invitation Flow**
   - Send invitation emails
   - Create invitation acceptance page
   - Allow signup via invitation token
   - Auto-assign to organization

2. **Sync User Context to Database**
   - Create `/api/user/context` endpoint
   - Update extension to sync on save
   - Show user context in org dashboard

3. **Show Organization Context in Extension**
   - Display org name in header
   - Show role badge for admins
   - Link to org dashboard for admins

### üü° MEDIUM PRIORITY

4. **Differentiate Individual vs Org User Experience**
   - Show "Personal Workspace" for individual users
   - Show org name for org members
   - Add team activity indicator

5. **Protect Admin Routes**
   - Add role checks to `/admin/page.tsx`
   - Redirect non-admins
   - Show proper error messages

### üü¢ LOW PRIORITY

6. **Add Integration Functionality**
   - Actually check enabled integrations in extension
   - Show/hide features based on org integrations
   - Implement Salesforce/HubSpot sync

7. **Add Super Admin Features**
   - Global admin dashboard
   - Manage all organizations
   - System-wide settings

---

## üìà Recommendations Summary

Your system is **80% complete** for the core hierarchy functionality. The database schema, authentication, and authorization are excellent. The main gaps are:

1. **Transparency** - Users don't see their organizational context
2. **User Invitations** - Flow exists but not fully implemented
3. **UI Polish** - Individual vs org user experience not differentiated
4. **User Context Sync** - Extension and database not in sync

All of these are relatively minor fixes that won't require database changes. Your foundation is solid!

---

## Next Steps

Would you like me to implement any of these fixes? I can:

1. ‚úÖ Add organization context display to extension
2. ‚úÖ Create user context sync API endpoint
3. ‚úÖ Build invitation acceptance flow
4. ‚úÖ Add visual indicators for different user types
5. ‚úÖ Protect admin routes with proper checks

Let me know which you'd like to tackle first, or I can implement all the high-priority fixes in one go!

